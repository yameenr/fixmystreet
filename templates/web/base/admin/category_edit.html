[% INCLUDE 'admin/header.html' title=tprintf(loc('Council contacts for %s'), body.name) -%]

[% BLOCK highlightchanged_yesno %]
[%- output = loc('No') %]
[%- IF new.$value %][% output = loc('Yes') %][% END %]
[%- IF old && old.$value != new.$value %]<strong>[% output %]</strong>[% ELSE %][% output %][% END %]
[%- END %]

[% BLOCK highlightchanged %]
[%- IF old && old.$value != new.$value %]<strong>[% new.$value %]</strong>[% ELSE %][% new.$value %][% END %]
[%- END %]
<p>
<em>[% updated %]</em>
</p>

<p>
[% IF example_pc %]
<a href="[% c.uri_for_email( '/around', { pc => example_pc } ) %]" class="admin-offsite-link">[% tprintf( loc('Example postcode %s'), example_pc ) | html %]</a>
[% END %]
</p>

<form method="post" action="[% c.uri_for('body', body_id ) %]" enctype="application/x-www-form-urlencoded" accept-charset="utf-8" id="category_edit">
    <p><strong>[% loc('Category:') %] </strong>[% contact.category | html %]
    <input type="hidden" name="category" value="[% contact.category | html %]" >
    <input type="hidden" name="token" value="[% csrf_token %]" >

    <p><strong>[% loc('Email:') %] </strong>
    <input type="text" class="form-control" name="email" value="[% contact.email | html %]" size="30">

    <p>
      [% IF c.cobrand.moniker != 'zurich' %]
        <input type="checkbox" name="confirmed" value="1" id="confirmed"[% ' checked' IF contact.confirmed %]>
        <label class="inline" for="confirmed">[% loc('Confirmed' ) %]</label>
      [% ELSE %]
        <input type="hidden" name="confirmed" value="1">
      [% END %]
        <input type="checkbox" name="deleted" value="1" id="deleted"[% ' checked' IF contact.deleted %]>
        <label class="inline" for="deleted">[% loc('Deleted') %]</label>
      [% IF c.cobrand.moniker != 'zurich' %]
        <input type="checkbox" name="non_public" value="1" id="non_public"[% ' checked' IF contact.non_public %]>
        <label class="inline" for="non_public">[% loc('Private') %]</label>
        <input type="checkbox" name="inspection_required" value="1" id="inspection_required"[% ' checked' IF contact.get_extra_metadata('inspection_required') %]>
        <label class="inline" for="inspection_required">[% loc('Inspection required') %]</label>
      [% ELSE %]
        <input type="checkbox" name="photo_required" value="1" id="photo_required"[% ' checked' IF contact.get_extra_metadata('photo_required') %]>
        <label class="inline" for="photo_required">[% loc('Photo required') %]</label>
      [% END %]
    </p>

    [% IF c.cobrand.moniker != 'zurich' %]
      <p [% 'class=hidden' UNLESS contact.get_extra_metadata('inspection_required') %]>
        <label>
          [% loc('Reputation threshold:') %]
          <input type="text" class="form-control" name="reputation_threshold" id="reputation_threshold"
            value="[% contact.get_extra_metadata('reputation_threshold') | html %]" size="30">
        </label>
      </p>
    [% END %]

    <p><strong>[% loc('Note:') %] </strong><textarea class="form-control" name="note" rows="3" cols="40"></textarea>

    [% IF body.can_be_devolved %]
    <h2>[% loc('Configure Endpoint') %]</h2>
    <form method="post" action="[% c.uri_for('body', body_id ) %]" enctype="application/x-www-form-urlencoded" accept-charset="utf-8">
    <p>
        <label for="endpoint">Endpoint</label>
        <input type="text" class="form-control" name="endpoint" id="endpoint" value="[% contact.endpoint | html %]" size="50">
    </p>

    <p>
        <label for="jurisdiction">Jurisdiction</label>
        <input type="text" class="form-control" name="jurisdiction" id="jurisdiction" value="[% contact.jurisdiction | html %]" size="50">
    </p>

    <p>
        <label for="api_key">Api Key</label>
        <input type="text" class="form-control" name="api_key" id="api_key" value="[% contact.api_key | html %]" size="25">
    </p>

    <p>
        <label for="send_method">Send Method</label>
        <select class="form-control" name="send_method">
            <option value=""> -- Select a method -- </option>
            [% FOR method IN send_methods %]
            <option value="[% method %]"[% ' selected' IF contact.send_method == method %]>[% method %]</option>
            [% END %]
        </select>
    </p>
    [% END %]

    <input type="hidden" name="posted" value="new">
    <p><input type="submit" class="btn" name="Save changes" value="[% loc('Save changes') %]">
</form>

[% IF contact.extra %]
<h2>[% loc('Extra data:') %] </h2>
<dl>
  [% FOR pair IN contact.get_extra_metadata %]
    <dt>[% pair.key %]</dt> <dd>[% pair.value %]</dd>
  [% END %]
</dl>
<ul>
  [% FOR meta IN contact.get_metadata_for_input %]
    <li>
        [% meta.order %], <code>[% meta.code %]</code>, [% meta.datatype %],
        [% meta.required == 'true' ? loc('required') : loc('optional') %]
        <br><small>[% meta.description %]</small>
      [% IF meta.variable != 'false' AND meta.exists('values') %]
        <ul>
          [% FOR option IN meta.values %]
            <li>[% option.name %] <small>([% option.key %])</small></li>
          [% END %]
        </ul>
      [%- END %]
    </li>
  [%- END %]
</ul>
[% END %]

<h2>[% loc('History') %]</h2>
<table border="1">
    <tr>
        <th>[% loc('When edited') %]</th>
        <th>[% loc('Email') %]</th>
        <th>[% loc('Confirmed') %]</th>
        <th>[% loc('Deleted') %]</th>
        <th>[% loc('Editor') %]</th>
        <th>[% loc('Note') %]</th>
    </tr>
    [%- prev = '' %]
    [%- WHILE ( contact = history.next ) %]
    <tr>
        <td>[% contact.whenedited.ymd _ ' ' _ contact.whenedited.hms %]</td>
        <td>[% PROCESS highlightchanged old=prev new=contact value='email' %]</td>
        <td>[% PROCESS highlightchanged_yesno old=prev new=contact value='confirmed' %]</td>
        <td>[% PROCESS highlightchanged_yesno old=prev new=contact value='deleted' %]</td>
        <td>[% contact.editor | html %]</td>
        <td>[% contact.note | html %]</td>
    </tr>
        [%- prev = contact %]
    [%- END %]
</table>

[% INCLUDE 'admin/footer.html' %]
